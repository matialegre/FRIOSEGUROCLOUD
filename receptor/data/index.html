<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campamento Parametican Silver - Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(90deg, #0f3460 0%, #533483 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header .subtitle { color: #aaa; font-size: 0.9em; }
        .header .coords { color: #e94560; font-size: 0.8em; margin-top: 5px; }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            flex-wrap: wrap;
        }
        
        .status-item { display: flex; align-items: center; gap: 8px; }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online { background: #00ff88; }
        .status-dot.offline { background: #ff4444; animation: none; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .card.alert {
            border-color: #e94560;
            animation: alertPulse 1s infinite;
        }
        
        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.4); }
            50% { box-shadow: 0 0 20px 10px rgba(233, 69, 96, 0.2); }
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title { font-size: 1.2em; font-weight: bold; }
        
        .card-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .card-status.online { background: #00ff88; color: #000; }
        .card-status.offline { background: #666; color: #fff; }
        
        .temp-display { text-align: center; padding: 20px 0; }
        
        .temp-value {
            font-size: 3.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .temp-value.warning {
            background: linear-gradient(135deg, #ff9800, #ff5722);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .temp-value.critical {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .temp-value.offline {
            background: #666;
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .temp-label { color: #aaa; margin-top: 5px; }
        
        .sensors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .sensor-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .sensor-value { font-size: 1.3em; font-weight: bold; }
        .sensor-label { font-size: 0.8em; color: #888; }
        
        .door-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .door-status.closed { background: rgba(0, 255, 136, 0.1); color: #00ff88; }
        .door-status.open { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        
        .map-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .map-frame {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            border: none;
            background: #222;
        }
        
        .config-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .config-item { display: flex; flex-direction: column; gap: 5px; }
        .config-item label { color: #aaa; font-size: 0.9em; }
        
        .config-item input {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            font-size: 1em;
        }
        
        .btn {
            background: linear-gradient(135deg, #e94560, #533483);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }
        
        .btn-secondary { background: rgba(255,255,255,0.1); }
        
        .alerts-panel {
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid #e94560;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alerts-panel.active { display: block; }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .alert-icon { font-size: 2em; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: bold; margin-bottom: 5px; }
        .alert-message { color: #aaa; font-size: 0.9em; }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
        
        .history-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .chart-container {
            height: 200px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            gap: 2px;
            overflow-x: auto;
        }
        
        .chart-bar {
            flex: 1;
            min-width: 4px;
            background: linear-gradient(to top, #00d4ff, #00ff88);
            border-radius: 2px 2px 0 0;
            transition: height 0.3s;
        }
        
        .chart-bar.warning { background: linear-gradient(to top, #ff9800, #ff5722); }
        .chart-bar.critical { background: linear-gradient(to top, #ff4444, #cc0000); }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.3em; }
            .temp-value { font-size: 2.5em; }
            .status-bar { gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèîÔ∏è CAMPAMENTO PARAMETICAN SILVER</h1>
        <div class="subtitle">Sistema de Monitoreo de Temperatura - RIFTs</div>
        <div class="coords">üìç Cerro Moro | 48¬∞7'49.57"S, 66¬∞39'10.42"W</div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <div class="status-dot" id="wifiStatus"></div>
            <span>WiFi Local</span>
        </div>
        <div class="status-item">
            <div class="status-dot" id="internetStatus"></div>
            <span>Internet</span>
        </div>
        <div class="status-item">
            <span id="currentTime">--:--:--</span>
        </div>
        <div class="status-item">
            <span>Uptime: <span id="uptime">0h 0m</span></span>
        </div>
    </div>
    
    <div class="container">
        <div class="alerts-panel" id="alertsPanel">
            <h3>‚ö†Ô∏è Alertas Activas</h3>
            <div id="alertsList"></div>
        </div>
        
        <div class="grid" id="riftsGrid"></div>
        
        <div class="history-section">
            <h3>üìä Historial de Temperatura - RIFT-01</h3>
            <div class="chart-container" id="chartContainer"></div>
        </div>
        
        <div class="map-container">
            <div class="map-header">
                <h3>üìç Ubicaci√≥n del Campamento</h3>
                <a href="https://www.google.com/maps?q=-48.130438,-66.652895" target="_blank" class="btn btn-secondary">
                    Abrir en Google Maps
                </a>
            </div>
            <iframe 
                class="map-frame"
                src="https://www.openstreetmap.org/export/embed.html?bbox=-66.68,-48.15,-66.62,-48.11&layer=mapnik&marker=-48.130438,-66.652895"
                allowfullscreen>
            </iframe>
        </div>
        
        <div class="config-section">
            <h3>‚öôÔ∏è Configuraci√≥n de Alertas</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>Temperatura M√°xima (¬∞C)</label>
                    <input type="number" id="configTempMax" value="-18" step="0.5">
                </div>
                <div class="config-item">
                    <label>Temperatura Cr√≠tica (¬∞C)</label>
                    <input type="number" id="configTempCrit" value="-10" step="0.5">
                </div>
                <div class="config-item">
                    <label>Tiempo m√≠nimo alerta (seg)</label>
                    <input type="number" id="configMinDur" value="300" step="60">
                </div>
                <div class="config-item">
                    <label>M√°x. puerta abierta (seg)</label>
                    <input type="number" id="configDoorMax" value="180" step="30">
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" onclick="saveConfig()">üíæ Guardar</button>
                <button class="btn btn-secondary" onclick="testAlert()">üîî Probar Alerta</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Campamento Parametican Silver - Cerro Moro, Santa Cruz, Argentina</p>
        <p>Sistema de monitoreo para RIFTs en condiciones extremas (-40¬∞C a +20¬∞C)</p>
    </div>
    
    <script>
        let configData = {};
        
        setInterval(updateData, 5000);
        updateData();
        loadConfig();
        loadHistory();
        
        async function updateData() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('wifiStatus').className = 'status-dot online';
                document.getElementById('internetStatus').className = 
                    'status-dot ' + (data.internet ? 'online' : 'offline');
                document.getElementById('currentTime').textContent = 
                    data.current_time || new Date().toLocaleTimeString();
                
                const hours = Math.floor(data.uptime / 3600);
                const mins = Math.floor((data.uptime % 3600) / 60);
                document.getElementById('uptime').textContent = hours + 'h ' + mins + 'm';
                
                renderRifts(data.rifts);
                
                const activeAlerts = data.rifts.filter(r => r.alert_active);
                const alertsPanel = document.getElementById('alertsPanel');
                const alertsList = document.getElementById('alertsList');
                
                if (activeAlerts.length > 0) {
                    alertsPanel.classList.add('active');
                    alertsList.innerHTML = activeAlerts.map(r => `
                        <div class="alert-item">
                            <div class="alert-icon">üö®</div>
                            <div class="alert-content">
                                <div class="alert-title">${r.name} - ${r.location}</div>
                                <div class="alert-message">${r.alert_message}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    alertsPanel.classList.remove('active');
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('wifiStatus').className = 'status-dot offline';
            }
        }
        
        function renderRifts(rifts) {
            const grid = document.getElementById('riftsGrid');
            
            grid.innerHTML = rifts.map(rift => {
                const tempClass = getTempClass(rift.temp_avg, rift.online);
                const doorClass = rift.door_open ? 'open' : 'closed';
                const cardClass = rift.alert_active ? 'card alert' : 'card';
                
                return `
                    <div class="${cardClass}">
                        <div class="card-header">
                            <div class="card-title">${rift.name}</div>
                            <div class="card-status ${rift.online ? 'online' : 'offline'}">
                                ${rift.online ? 'ONLINE' : 'OFFLINE'}
                            </div>
                        </div>
                        <div class="temp-display">
                            <div class="temp-value ${tempClass}">
                                ${rift.online && rift.temp_avg !== -999 ? 
                                    rift.temp_avg.toFixed(1) + '¬∞C' : '--'}
                            </div>
                            <div class="temp-label">${rift.location}</div>
                        </div>
                        <div class="sensors-grid">
                            <div class="sensor-item">
                                <div class="sensor-value">
                                    ${rift.temp1 !== -999 ? rift.temp1.toFixed(1) + '¬∞' : '--'}
                                </div>
                                <div class="sensor-label">Sensor 1</div>
                            </div>
                            <div class="sensor-item">
                                <div class="sensor-value">
                                    ${rift.temp2 !== -999 ? rift.temp2.toFixed(1) + '¬∞' : '--'}
                                </div>
                                <div class="sensor-label">Sensor 2</div>
                            </div>
                        </div>
                        <div class="door-status ${doorClass}">
                            <span>${rift.door_open ? 'üö™ PUERTA ABIERTA' : 'üîí Puerta Cerrada'}</span>
                            ${rift.door_open && rift.door_open_since > 0 ? 
                                '<span>(' + rift.door_open_since + 's)</span>' : ''}
                        </div>
                        ${rift.online ? `<div style="text-align:center;margin-top:10px;color:#666;font-size:0.8em">
                            üì∂ ${rift.rssi} dBm
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function getTempClass(temp, online) {
            if (!online || temp === -999) return 'offline';
            if (temp > configData.temp_critical || temp > -10) return 'critical';
            if (temp > configData.temp_max || temp > -18) return 'warning';
            return '';
        }
        
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                configData = await response.json();
                
                document.getElementById('configTempMax').value = configData.temp_max;
                document.getElementById('configTempCrit').value = configData.temp_critical;
                document.getElementById('configMinDur').value = configData.min_duration;
                document.getElementById('configDoorMax').value = configData.door_max;
            } catch (e) {
                console.error('Error loading config:', e);
            }
        }
        
        async function saveConfig() {
            const config = {
                temp_max: parseFloat(document.getElementById('configTempMax').value),
                temp_critical: parseFloat(document.getElementById('configTempCrit').value),
                min_duration: parseInt(document.getElementById('configMinDur').value),
                door_max: parseInt(document.getElementById('configDoorMax').value)
            };
            
            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                configData = config;
                alert('Configuraci√≥n guardada');
            } catch (e) {
                alert('Error al guardar');
            }
        }
        
        async function testAlert() {
            try {
                await fetch('/api/test-alert', { method: 'POST' });
                alert('Alerta de prueba enviada');
            } catch (e) {
                alert('Error al enviar alerta');
            }
        }
        
        async function loadHistory() {
            try {
                const response = await fetch('/api/history?rift=1&period=hour');
                const data = await response.json();
                renderChart(data.data);
            } catch (e) {
                console.error('Error loading history:', e);
            }
        }
        
        function renderChart(data) {
            const container = document.getElementById('chartContainer');
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="color:#666;margin:auto">Sin datos de historial</div>';
                return;
            }
            
            const minTemp = -40;
            const maxTemp = 0;
            const range = maxTemp - minTemp;
            
            container.innerHTML = data.slice(0, 100).reverse().map(point => {
                const temp = point.temp;
                if (temp === -999) return '';
                
                const height = Math.max(5, ((temp - minTemp) / range) * 100);
                let barClass = 'chart-bar';
                if (temp > -10) barClass += ' critical';
                else if (temp > -18) barClass += ' warning';
                
                return `<div class="${barClass}" style="height:${height}%" title="${temp.toFixed(1)}¬∞C"></div>`;
            }).join('');
        }
        
        setInterval(loadHistory, 60000);
    </script>
</body>
</html>
